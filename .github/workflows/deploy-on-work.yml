name: Deploy myapp application

on:
  push:
    branches:
      - main

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # ... 其他步骤 ...

      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: basketball223/my-final-work:latest

      # ... 其他步骤 ...

      - name: SSH and Deploy
        env:
          DOCKER_HUB_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}
        run: |
          ssh ${{ secrets.HOST_USER_NAME }}@${{ secrets.HOST_SERVER }} -p ${{ secrets.PORT }} -i ${{ secrets.HOST_SSH_PRIVATE_KEY }} << EOF
          cd /home/ubuntu/myapp
          echo "$DOCKER_HUB_TOKEN" | docker login --username ${{ secrets.DOCKER_HUB_USERNAME }} --password-stdin
          docker-compose -f docker-compose.yml down
          docker-compose -f docker-compose.yml pull
          docker-compose -f docker-compose.yml up -d
          EOF